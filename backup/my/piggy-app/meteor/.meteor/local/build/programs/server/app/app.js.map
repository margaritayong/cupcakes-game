{"version":3,"sources":["meteor://ğŸ’»app/imports/api/goal.js","meteor://ğŸ’»app/server/main.js"],"names":["module","export","Goal","Mongo","watch","require","v","check","Collection","Meteor","isServer","publish","goalPublication","find","methods","targetGoal","upsert","$set","updatedAt","Date","config","client","default","connect","SerialPort","Readline","parsers","parser","port","baudRate","pipe","onData","data","console","log","on","bindEnvironment","err","message","writeSerialData","buffer","Buffer","from","write","saveGoalInDataBase","call","mqttHost","mqttPort","onMessage","topic","toString","subscribe","startup"],"mappings":"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","file":"/app.js","sourcesContent":["import { Mongo } from 'meteor/mongo';\nexport const Goal = new Mongo.Collection('goal');\nimport { check } from 'meteor/check';\n\n\nif (Meteor.isServer) {\n  // This code only runs on the server\n  Meteor.publish('goal', function goalPublication() {\n    return Goal.find({});\n  });\n}\n\n// http://docs.meteor.com/api/collections.html#Mongo-Collection-upsert\nMeteor.methods({\n  'goals.upsert'(targetGoal) {\n\n    Goal.upsert({\n      targetGoal: targetGoal\n    },\n    {\n      $set: {\n        targetGoal: targetGoal,\n        updatedAt: new Date(),\n      }\n    });\n  }\n})","import { Meteor } from 'meteor/meteor';\nimport Goal from '../imports/api/goal.js'\nimport { connect } from 'mqtt/lib/connect';\nimport SerialPort from 'serialport';\n \nconst Readline = SerialPort.parsers.Readline;\nconst parser = new Readline();\nvar port = new SerialPort('/dev/cu.usbmodem1431', {\n  baudRate: 9600\n});\nport.pipe(parser);\n\n\n// parse the data from serial into meaningful objects\nfunction onData(data) {\n  console.log(\"meteor onData: \" + data);\n  \n  // send the character over mqtt\n  // client.publish(\"led\", text);\n}\n\n// setup the callback for the parser\n// our callback function must be wrapped in Meteor.bindEnvironment to avoid Fiber errors\nparser.on('data', Meteor.bindEnvironment(onData));\n\n// setup the callback for the port\n// Open errors will be emitted as an error event\nport.on('error', function(err) {\n  console.log('Error: ', err.message);\n})\n\n// serial event\nfunction writeSerialData(data) {\n  var buffer = Buffer.from(data);\n\n  port.write(data, function(err) {\n    if (err) {\n      return console.log('Error on write: ', err.message);\n    }\n    console.log('meteor wrote', data);\n  });\n\n}\n\nfunction saveGoalInDataBase(targetGoal) {\n  Meteor.call('goals.upsert', targetGoal);\n}\n\n// meteor\nMeteor.methods({\n  'send.goal'(targetGoal) {\n\n    console.log(\"Meteor send.goal\", targetGoal);\n    client.publish(\"targetGoal\", targetGoal); // publish via mqtt\n\n  }\n})\n\n \n// MQTT\nexport const config = {\n  mqttHost: \"mqtt://127.0.0.1\",\n  mqttPort: 1883\n};\n\nexport const client = connect(config.mqttHost);\n\nfunction onMessage(topic, message) {\n  if (topic === \"targetGoal\") {\n    console.log(\"message\", message.toString());\n    Meteor.call('goals.upsert', targetGoal);\n  }\n}\n\n// client callback\nclient.on('message', Meteor.bindEnvironment(onMessage));\n\nclient.on(\"connect\", function() {\n  console.log(\"---- mqtt client connected ----\");\n  client.subscribe(\"targetGoal\"); // subscribe to the targetGoal topic\n})\n\nMeteor.startup(() => {\n  // code to run on server at startup\n});\n"]}